services:
  pharm-sync:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: pharm-sync
    environment:
      - PORT=8787
      - DB_PATH=/data/app.db
      - JWT_SECRET=${JWT_SECRET:?set JWT_SECRET in .env}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - GEMINI_API_KEY=${GEMINI_API_KEY:?set GEMINI_API_KEY in .env}
      - AI_IMPORT_PRO_RPM=${AI_IMPORT_PRO_RPM:-10}
      - AI_IMPORT_FLASH_RPM=${AI_IMPORT_FLASH_RPM:-20}
      - AI_IMPORT_MIN_START_INTERVAL_MS=${AI_IMPORT_MIN_START_INTERVAL_MS:-1000}
      - AI_IMPORT_PRO_MAX_IN_FLIGHT=${AI_IMPORT_PRO_MAX_IN_FLIGHT:-10}
      - AI_IMPORT_FLASH_MAX_IN_FLIGHT=${AI_IMPORT_FLASH_MAX_IN_FLIGHT:-20}
      - AI_IMPORT_MAX_FILE_SIZE_BYTES=${AI_IMPORT_MAX_FILE_SIZE_BYTES:-20971520}
      - AI_UPLOADS_DIR=/data/ai_uploads
    volumes:
      - pharm_sync_data:/data
    ports:
      - "127.0.0.1:8787:8787"
    restart: unless-stopped
    networks:
      - ai_net
networks:
  ai_net:
    # Share an external network with Nginx Proxy Manager (so it can reach `pharm-sync:8787`).
    # Create it once: `docker network create ai_net`
    name: ${AI_NET_NAME:-ai_net}
    external: ${AI_NET_EXTERNAL:-true}
    
volumes:
  pharm_sync_data:
