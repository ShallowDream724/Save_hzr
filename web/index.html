<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拯救Hzr</title>
    <!-- 可选：设置 API_BASE（留空则同源），如：https://qianmeng.me -->
    <meta name="hzr-api-base" content="">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="./app.js" defer></script>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <div class="brand-left">
                    <i class="fa-solid fa-flask-vial"></i>
                    <span class="brand-text">拯救Hzr</span>
                </div>
                <button id="sidebarCollapseBtn" class="collapse-btn" type="button" title="折叠侧边栏">
                    <i class="fa-solid fa-angles-left"></i>
                </button>
            </div>
            
            <!-- 章节列表容器 -->
            <div class="chapter-list" id="chapterList">
                <!-- JS将在这里渲染文件夹和章节 -->
            </div>

            <!-- 底部功能区 -->
            <div class="sidebar-footer">
                <!-- 主页 -->
                <button id="sidebarHomeBtn" class="action-btn icon-btn" title="主页">
                    <i class="fa-solid fa-book"></i>
                </button>

                <!-- 新建文件夹 -->
                <button id="addFolderBtn" class="action-btn icon-btn" title="新建文件夹">
                    <i class="fa-solid fa-folder-plus"></i>
                </button>

                <!-- 导入（文件/粘贴合并） -->
                <button id="importBtn" class="action-btn icon-btn" title="导入（文件/粘贴）">
                    <i class="fa-solid fa-file-import"></i>
                </button>

                <!-- 同步/账号 -->
                <button id="syncBtn" class="action-btn icon-btn" title="同步/账号">
                    <i class="fa-solid fa-cloud"></i>
                </button>

                <!-- 设置 -->
                <button id="settingsBtn" class="action-btn icon-btn" title="设置">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </aside>

        <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

        <main class="main-content">
            <header class="top-bar">
                <button id="menuToggle" class="menu-toggle"><i class="fa-solid fa-bars"></i></button>
                <button id="homeBtn" class="menu-toggle" title="主页"><i class="fa-solid fa-book"></i></button>
                <h2 id="currentChapterTitle">请选择章节</h2>
                <div id="syncStatus" style="margin-left:auto; font-size:0.9rem; color:#888;"></div>
            </header>
            
            <div id="homeView" class="home-view" style="display:none;">
                <div class="home-hud">
                    <div class="home-hud-title">我的题库</div>
                    <div class="home-hud-actions">
                        <button id="homeSyncBtn" class="modal-btn" type="button" title="云同步"><i class="fa-solid fa-cloud" style="margin-right:8px;"></i>云同步</button>
                        <button id="homeSavesBtn" class="modal-btn" type="button" title="存档"><i class="fa-solid fa-box-archive" style="margin-right:8px;"></i>存档</button>
                        <button id="homeSettingsBtn" class="modal-btn" type="button" title="设置"><i class="fa-solid fa-gear" style="margin-right:8px;"></i>设置</button>
                        <button id="importBookBtn" class="modal-btn" type="button"><i class="fa-solid fa-file-import" style="margin-right:8px;"></i>导入书</button>
                        <button id="newBookBtn" class="modal-btn primary" type="button"><i class="fa-solid fa-plus" style="margin-right:8px;"></i>新建书</button>
                    </div>
                </div>
                <div id="booksGrid" class="shelf" aria-label="书架"></div>
            </div>

            <div class="questions-container" id="questionsContainer">
                <div class="welcome-message">
                    <h3>欢迎复习</h3>
                    <p>您可以：</p>
                    <ul style="margin-left:20px; color:#666;">
                        <li>点击“新建文件夹”整理题库</li>
                        <li>将章节<b>拖拽</b>到文件夹中（移动端可按住右侧<b>拖拽</b>按钮）</li>
                        <li><b>双击</b>名称进行重命名</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <button id="fabMenu" class="fab-menu" type="button" aria-label="菜单">
        <i class="fa-solid fa-bars"></i>
    </button>

    <div class="toast-host" id="toastHost" aria-live="polite" aria-atomic="true"></div>

    <div class="modal-overlay" id="importModal">
        <div class="modal-box">
            <h3>导入题库</h3>
            <div class="seg-tabs" style="margin:12px 0 8px;">
                <button id="importTabFile" class="seg-tab active" type="button">文件</button>
                <button id="importTabPaste" class="seg-tab" type="button">粘贴</button>
            </div>

            <div id="importPaneFile">
                <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
                    <input type="file" id="importFileInput" accept=".json">
                </div>
                <div style="color:#667085; font-size:0.92rem;">支持 JSON：单章节/多章节/文件夹树/完整结构。</div>
            </div>

            <div id="importPanePaste" style="display:none;">
                <textarea id="importTextarea" placeholder='{"title": "...", "questions": [...]}'></textarea>
                <div class="modal-actions">
                    <button id="cancelImportBtn" class="modal-btn">取消</button>
                    <button id="confirmImportBtn" class="modal-btn primary">导入</button>
                </div>
            </div>

            <div class="modal-actions" style="margin-top:14px;">
                <button id="closeImportBtn" class="modal-btn">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="folderModal">
        <div class="modal-box">
            <h3>新建文件夹</h3>
            <div style="display:grid; gap:10px; margin-top:10px;">
                <input id="folderNameInput" class="auth-input" placeholder="文件夹名称">
            </div>
            <div class="modal-actions" style="margin-top:14px;">
                <button id="folderCancelBtn" class="modal-btn">取消</button>
                <button id="folderCreateBtn" class="modal-btn primary">创建</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bookModal">
        <div class="modal-box">
            <h3>新建书</h3>
            <div style="display:grid; gap:10px; margin-top:12px;">
                <input id="bookNameInput" class="auth-input" placeholder="书名（例如：药理学）">
                <div style="color:#667085; font-size:0.92rem;">新建后进入空白书，可用“导入”导入 JSON 构建题库。</div>

                <div style="margin-top:6px;">
                    <div style="font-weight:700; color:#334155; margin-bottom:8px;">颜色</div>
                    <div id="bookThemeChoices" class="choice-grid" aria-label="书本颜色"></div>
                </div>

                <div style="margin-top:2px;">
                    <div style="font-weight:700; color:#334155; margin-bottom:8px;">图标</div>
                    <div id="bookIconChoices" class="choice-grid choice-grid--icons" aria-label="书本图标"></div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top:14px;">
                <button id="bookCancelBtn" class="modal-btn">取消</button>
                <button id="bookCreateBtn" class="modal-btn primary">创建</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal-box">
            <h3 style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
                <span>云同步</span>
                <span id="syncModalStatus" style="font-size:0.9rem; font-weight:600; color:#667085;"></span>
            </h3>

            <div class="seg-tabs" style="margin:12px 0 8px;">
                <button id="syncTabAccount" class="seg-tab active" type="button">账号</button>
                <button id="syncTabSaves" class="seg-tab" type="button">存档</button>
                <button id="authLogoutBtn" class="modal-btn" type="button" style="margin-left:auto; display:none;">退出登录</button>
            </div>

            <div id="syncPaneAccount">
                <div style="display:flex; gap:10px; margin:10px 0;">
                    <button id="authTabLogin" class="modal-btn primary" type="button">登录</button>
                    <button id="authTabRegister" class="modal-btn" type="button">注册</button>
                </div>
                <div style="display:grid; gap:10px;">
                    <input id="authUsername" class="auth-input" placeholder="用户名（3-32位，字母数字._-）">
                    <input id="authPassword" class="auth-input" placeholder="密码（>=8位）" type="password">
                    <div id="authHint" style="color:#667085; font-size:0.9rem;"></div>
                </div>
                <div id="syncEnableRow" style="display:none; margin-top:12px; padding:10px 12px; border:1px solid rgba(197,74,90,0.22); background:rgba(197,74,90,0.06); border-radius:12px;">
                    <div style="font-weight:700; color:#7b2c36;">云同步未启用</div>
                    <div style="margin-top:6px; color:#667085; font-size:0.92rem;">云端为空或同步未完成初始化时，为避免误覆盖，系统不会自动上传本机。</div>
                    <div class="modal-actions" style="margin-top:10px; justify-content:flex-start;">
                        <button id="enableSyncUploadBtn" class="modal-btn primary" type="button">上传本机到云端（启用同步）</button>
                    </div>
                    <div id="enableSyncHint" style="margin-top:6px; color:#667085; font-size:0.9rem;"></div>
                </div>
                <div class="modal-actions" style="margin-top:14px;">
                    <button id="authCancelBtn" class="modal-btn">关闭</button>
                    <button id="authSubmitBtn" class="modal-btn primary">提交</button>
                </div>
            </div>

            <div id="syncPaneSaves" style="display:none;">
                <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
                    <input id="archiveName" class="auth-input" placeholder="存档名（可选）">
                    <button id="createArchiveBtn" class="modal-btn primary" type="button">新建存档</button>
                    <button id="refreshSavesBtn" class="modal-btn" type="button">刷新</button>
                </div>

                <div class="save-section">
                    <div class="save-title">手动存档</div>
                    <div id="archivesList" class="save-list"></div>
                </div>

                <div class="save-section" style="margin-top:14px;">
                    <div class="save-title">自动存档（每 5 分钟）</div>
                    <div id="revisionsList" class="save-list"></div>
                </div>

                <div id="savesHint" style="margin-top:10px; color:#667085; font-size:0.9rem;"></div>
                <div class="modal-actions" style="margin-top:14px;">
                    <button id="savesCloseBtn" class="modal-btn">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-box">
            <h3>设置</h3>

            <div class="settings-section" style="margin-top:10px;">
                <div class="settings-title">外观（可自定义）</div>

                <div class="settings-row">
                    <div class="settings-label">解析色</div>
                    <div class="settings-control">
                        <input id="uiAnalysisColor" type="color">
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">知识点色</div>
                    <div class="settings-control">
                        <input id="uiKnowledgeColor" type="color">
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">强调（加粗）色</div>
                    <div class="settings-control">
                        <input id="uiEmphasisColor" type="color">
                    </div>
                </div>

                <div class="settings-row" style="align-items:flex-start;">
                    <div class="settings-label">高亮色盘（多选）</div>
                    <div class="settings-control">
                        <div id="uiHighlightPalette" class="swatch-grid"></div>
                        <div class="settings-inline">
                            <label>强度
                                <select id="uiHighlightIntensity">
                                    <option value="0.38">淡</option>
                                    <option value="0.55" selected>中</option>
                                    <option value="0.72">深</option>
                                </select>
                            </label>
                            <label>随机
                                <select id="uiHighlightMode">
                                    <option value="stable" selected>同题稳定</option>
                                    <option value="random">每次随机</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-inline" style="margin-top:10px;">
                    <button id="resetUiBtn" class="modal-btn" type="button">恢复默认配色</button>
                    <button id="exportLocalBtn" class="modal-btn" type="button">导出本地备份（JSON）</button>
                </div>

                <div class="settings-preview">
                    <div class="analysis-box">
                        <div class="analysis-title"><i class="fa-solid fa-lightbulb"></i> 解析</div>
                        <div class="analysis-content">示例：<span class="highlight">高亮</span> 与 <span class="bold-em">强调</span>。</div>
                    </div>
                    <details class="knowledge-details" open>
                        <summary class="knowledge-summary"><i class="fa-solid fa-book-medical"></i> 知识点：示例</summary>
                        <div class="knowledge-content">示例：<span class="highlight">随机高亮</span>、<span class="bold-em">关键词</span>。</div>
                    </details>
                </div>
            </div>

            <div class="danger-zone" style="margin-top:14px;">
                <div class="danger-title">危险操作</div>
                <div class="danger-desc">重置会清空本地导入/自建内容，并恢复预设题库。</div>
                <div class="modal-actions" style="justify-content:space-between; margin-top:10px;">
                    <button id="settingsCloseBtn" class="modal-btn" type="button">关闭</button>
                    <button id="resetToDefaultBtn" class="modal-btn danger" type="button">重置到默认</button>
                </div>
                <div id="resetHint" style="margin-top:10px; color:#667085; font-size:0.9rem;"></div>
            </div>
        </div>
    </div>

</body>
</html>
